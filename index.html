<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í–‰ë™ ë¶„ì„ ê¸°ë°˜ MBTI ì‹¬ì¸µ ì§„ë‹¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --accent-soft: #ff6b9d;
            --text: #e8e8e8;
            --text-dim: #a0a0a0;
            --bg: #0f0f1e;
            --card: #1e1e3f;
            --success: #4ecca3;
            --warning: #ffa500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, var(--primary) 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(78, 204, 163, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-soft) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .intro-screen,
        .question-screen,
        .result-screen {
            display: none;
        }

        .active {
            display: block;
        }

        .intro-card {
            background: var(--card);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: fadeIn 1s ease-out;
            border: 1px solid rgba(233, 69, 96, 0.2);
        }

        .intro-card h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            color: var(--accent-soft);
            margin-bottom: 30px;
        }

        .intro-card p {
            line-height: 1.8;
            color: var(--text-dim);
            margin-bottom: 20px;
        }

        .intro-card ul {
            list-style: none;
            margin: 30px 0;
        }

        .intro-card li {
            padding: 15px;
            margin: 10px 0;
            background: rgba(233, 69, 96, 0.1);
            border-left: 3px solid var(--accent);
            border-radius: 5px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .start-btn {
            width: 100%;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-soft) 100%);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(233, 69, 96, 0.5);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--secondary);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 40px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-soft) 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .question-card {
            background: var(--card);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s ease-out;
            border: 1px solid rgba(233, 69, 96, 0.2);
            margin-bottom: 30px;
        }

        .question-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent);
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .question-text {
            font-size: 1.5rem;
            line-height: 1.6;
            margin-bottom: 40px;
            color: var(--text);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            padding: 20px 30px;
            background: var(--secondary);
            border: 2px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.05rem;
            position: relative;
            overflow: hidden;
        }

        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(233, 69, 96, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .option:hover::before {
            left: 100%;
        }

        .option:hover {
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .option.selected {
            background: rgba(233, 69, 96, 0.2);
            border-color: var(--accent);
        }

        .option.toggled {
            animation: pulse 0.3s ease;
        }

        .metadata-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--success);
            border: 1px solid var(--success);
            display: none;
        }

        .metadata-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .result-card {
            background: var(--card);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(233, 69, 96, 0.2);
            animation: fadeInUp 0.6s ease-out;
        }

        .result-card h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: var(--accent-soft);
            margin-bottom: 15px;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-soft) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'JetBrains Mono', monospace;
        }

        .mbti-result {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: 10px;
            margin: 40px 0;
            background: linear-gradient(135deg, var(--accent) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Cormorant Garamond', serif;
        }

        .insight-section {
            background: var(--secondary);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid var(--accent);
        }

        .insight-section h4 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            color: var(--accent-soft);
            margin-bottom: 15px;
        }

        .chart-container {
            margin: 30px 0;
            padding: 30px;
            background: var(--card);
            border-radius: 15px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            width: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .bar-track {
            flex: 1;
            height: 30px;
            background: var(--secondary);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-soft) 100%);
            border-radius: 15px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 0.85rem;
            font-weight: 700;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .intro-card,
            .question-card {
                padding: 30px;
            }
            
            .mbti-result {
                font-size: 3rem;
                letter-spacing: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Behavioral MBTI Analysis</h1>
            <p class="subtitle">í–‰ë™ íŒ¨í„´ ì‹¬ì¸µ ë¶„ì„ ì‹œìŠ¤í…œ</p>
        </header>

        <!-- ì‹œì‘ í™”ë©´ -->
        <div class="intro-screen active">
            <div class="intro-card">
                <h2>ğŸ“Š í–‰ë™ ë¶„ì„ ê¸°ë°˜ ì‹¬ì¸µ ì§„ë‹¨</h2>
                <p>
                    ì´ ì‹œìŠ¤í…œì€ ë‹¹ì‹ ì˜ <strong>ì„ íƒ</strong>ë¿ë§Œ ì•„ë‹ˆë¼,
                    <strong>ì‘ë‹µ ê³¼ì •ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” ë¯¸ì„¸í•œ ì‹¬ë¦¬ì  ì‹ í˜¸</strong>ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
                </p>
                <p style="margin: 20px 0; line-height: 1.8; color: var(--text-dim);">
                    íŠ¹ì • íŒ¨í„´ì„ ì¸ìœ„ì ìœ¼ë¡œ ë§Œë“¤ë ¤ê³  ì‹œë„í•˜ë©´ ë¶„ì„ ì‹ ë¢°ë„ê°€ ê¸‰ê²©íˆ í•˜ë½í•˜ì—¬
                    ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <p style="margin-top: 30px; font-size: 1.1rem; color: var(--accent);">
                    ğŸ’¡ ê°€ì¥ ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ëŠ” ìœ ì¼í•œ ë°©ë²•ì€
                    <strong>'ê°€ì¥ ë¨¼ì € ë– ì˜¤ë¥´ëŠ” ìƒê°'</strong>ì„ ê·¸ëŒ€ë¡œ ì„ íƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
                </p>
                <button class="start-btn" onclick="startTest()">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <!-- ì§ˆë¬¸ í™”ë©´ -->
        <div class="question-screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="question-card">
                <div class="question-number" id="questionNumber">Question 1 of 24</div>
                <div class="question-text" id="questionText"></div>
                <div class="options" id="optionsContainer"></div>
            </div>
        </div>

        <!-- ê²°ê³¼ í™”ë©´ -->
        <div class="result-screen">
            <div class="mbti-result" id="mbtiResult">INTJ</div>
            
            <div class="result-grid">
                <div class="result-card">
                    <h3>ì‹ ë¢°ë„</h3>
                    <div class="result-value" id="confidenceScore">--</div>
                </div>
                <div class="result-card">
                    <h3>í‰ê·  ì‘ë‹µ ì‹œê°„</h3>
                    <div class="result-value" id="avgResponseTime">--</div>
                </div>
                <div class="result-card">
                    <h3>ì´ ì¬ì„ íƒ íšŸìˆ˜</h3>
                    <div class="result-value" id="totalToggles">--</div>
                </div>
                <div class="result-card">
                    <h3>ì •ì§ë„ ì ìˆ˜</h3>
                    <div class="result-value" id="honestyScore">--</div>
                </div>
            </div>

            <!-- ë°ì´í„° í’ˆì§ˆ ë¶„ì„ ë³´ê³ ì„œ -->
            <div class="insight-section" style="border-left-color: var(--warning); background: rgba(255, 165, 0, 0.05);">
                <h4 style="color: var(--warning);">ğŸ“Š ì‘ë‹µ ë°ì´í„° í’ˆì§ˆ ë¶„ì„</h4>
                <ul style="list-style: none; margin-top: 15px;">
                    <li style="margin-bottom: 10px; color: var(--text-dim);">
                        <strong style="color: var(--text);">ìœ íš¨ ì‘ë‹µë¥ :</strong> <span id="validResponseRate">--</span>
                    </li>
                    <li style="margin-bottom: 10px; color: var(--text-dim);">
                        <strong style="color: var(--text);">ì§‘ì¤‘ë„ ë¶„ì„:</strong> <span id="afkAnalysis">--</span>
                    </li>
                    <li style="margin-bottom: 10px; color: var(--text-dim);">
                        <strong style="color: var(--text);">ì‹ ë¢°ë„ ì½”ë©˜íŠ¸:</strong> <span id="qualityComment">--</span>
                    </li>
                </ul>
            </div>

            <div class="chart-container">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; margin-bottom: 20px; color: var(--accent-soft);">
                    MBTI ì§€í‘œë³„ í™•ì‹ ë„
                </h3>
                <div class="bar-chart" id="mbtiBarChart"></div>
            </div>

            <div class="insight-section">
                <h4>ğŸ§  í–‰ë™ íŒ¨í„´ ë¶„ì„</h4>
                <p id="behaviorInsight"></p>
            </div>

            <div class="insight-section">
                <h4>ğŸ­ ì •ì§ë„ ë° ìê¸°ê²€ì—´ ë³´ê³ </h4>
                <p id="validityInsight"></p>
            </div>

            <div class="insight-section">
                <h4>ğŸ’¡ ì¢…í•© í•´ì„</h4>
                <p id="comprehensiveInsight"></p>
            </div>
        </div>

        <!-- ë””ë²„ê·¸ ì˜¤ë²„ë ˆì´ -->
        <div class="metadata-overlay" id="metadataOverlay"></div>
    </div>

    <script>
        // ========== ë°ì´í„° êµ¬ì¡° ==========
        const questions = [
            // E vs I (ì™¸í–¥ vs ë‚´í–¥)
            { id: 1, text: "íŒŒí‹°ì— ê°”ì„ ë•Œ, ì²˜ìŒ ë³´ëŠ” ì‚¬ëŒì—ê²Œ ë¨¼ì € ë§ì„ ê±°ëŠ” í¸ì´ë‹¤.", dimension: "EI", direction: "E" },
            { id: 2, text: "í˜¼ì ìˆëŠ” ì‹œê°„ì´ ë‚˜ë¥¼ ì¶©ì „ì‹œí‚¨ë‹¤.", dimension: "EI", direction: "I" },
            { id: 3, text: "ì‚¬ëŒë“¤ê³¼ í•¨ê»˜ ìˆì„ ë•Œ ì—ë„ˆì§€ê°€ ë„˜ì¹œë‹¤.", dimension: "EI", direction: "E" },
            
            // S vs N (ê°ê° vs ì§ê´€)
            { id: 4, text: "ì¶”ìƒì ì¸ ê°œë…ë³´ë‹¤ êµ¬ì²´ì ì¸ ì‚¬ì‹¤ì´ ë” ì¤‘ìš”í•˜ë‹¤.", dimension: "SN", direction: "S" },
            { id: 5, text: "ë¯¸ë˜ì˜ ê°€ëŠ¥ì„±ì„ ìƒìƒí•˜ëŠ” ê²ƒì„ ì¦ê¸´ë‹¤.", dimension: "SN", direction: "N" },
            { id: 6, text: "ë¹„ìœ ë‚˜ ì€ìœ ë¥¼ ì‚¬ìš©í•´ì„œ ì„¤ëª…í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•œë‹¤.", dimension: "SN", direction: "N" },
            
            // T vs F (ì‚¬ê³  vs ê°ì •)
            { id: 7, text: "ê²°ì •ì„ ë‚´ë¦´ ë•Œ ë…¼ë¦¬ì™€ ê°ê´€ì„±ì„ ìš°ì„ ì‹œí•œë‹¤.", dimension: "TF", direction: "T" },
            { id: 8, text: "íƒ€ì¸ì˜ ê°ì •ì„ ê³ ë ¤í•˜ëŠ” ê²ƒì´ ì˜¬ë°”ë¥¸ íŒë‹¨ì˜ í•µì‹¬ì´ë‹¤.", dimension: "TF", direction: "F" },
            { id: 9, text: "ì‚¬ëŒë“¤ì´ ë¹„ë…¼ë¦¬ì ìœ¼ë¡œ í–‰ë™í•˜ë©´ ë‹µë‹µí•¨ì„ ëŠë‚€ë‹¤.", dimension: "TF", direction: "T" },
            
            // J vs P (íŒë‹¨ vs ì¸ì‹)
            { id: 10, text: "ê³„íš ì—†ì´ ì¦‰í¥ì ìœ¼ë¡œ ì›€ì§ì´ëŠ” ê²ƒì´ ë¶ˆí¸í•˜ë‹¤.", dimension: "JP", direction: "J" },
            { id: 11, text: "ë§ˆê° ì§ì „ê¹Œì§€ ì—¬ëŸ¬ ì˜µì…˜ì„ ì—´ì–´ë‘ëŠ” ê²ƒì„ ì„ í˜¸í•œë‹¤.", dimension: "JP", direction: "P" },
            { id: 12, text: "ì¼ë‹¨ ê³„íšì„ ì„¸ìš°ë©´ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ëŠ” í¸ì´ë‹¤.", dimension: "JP", direction: "J" },
            
            // ì¼ê´€ì„± ì²´í¬ ë¬¸í•­ (ê°™ì€ ì˜ë¯¸, ë‹¤ë¥¸ í‘œí˜„)
            { id: 13, text: "ì‚¬êµ ëª¨ì„ë³´ë‹¤ ì¡°ìš©í•œ ë…ì„œë¥¼ ë” ì¦ê¸´ë‹¤.", dimension: "EI", direction: "I", consistency: 2 },
            { id: 14, text: "ì„¸ë¶€ ì‚¬í•­ë³´ë‹¤ëŠ” í° ê·¸ë¦¼ì„ ë³´ëŠ” ê²ƒì„ ì„ í˜¸í•œë‹¤.", dimension: "SN", direction: "N", consistency: 5 },
            { id: 15, text: "ì¹œêµ¬ê°€ ê³ ë¯¼ ìƒë‹´ì„ í•  ë•Œ, í•´ê²°ì±…ë³´ë‹¤ ê³µê°ì„ ë¨¼ì € í•œë‹¤.", dimension: "TF", direction: "F", consistency: 8 },
            { id: 16, text: "ìƒí™©ì— ë”°ë¼ ìœ ì—°í•˜ê²Œ ëŒ€ì²˜í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì´ë‹¤.", dimension: "JP", direction: "P", consistency: 11 },
            
            // Lie Scale (ì‚¬íšŒì  ë°”ëŒì§ì„±)
            { id: 17, text: "ë‚˜ëŠ” ë‹¨ í•œ ë²ˆë„ ë‚¨ì˜ í—˜ë‹´ì„ í•œ ì ì´ ì—†ë‹¤.", dimension: "LIE", direction: "LIE" },
            { id: 18, text: "ë‚˜ëŠ” í•­ìƒ ì•½ì† ì‹œê°„ì„ ì •í™•íˆ ì§€í‚¨ë‹¤.", dimension: "LIE", direction: "LIE" },
            { id: 19, text: "ë‚˜ëŠ” ì ˆëŒ€ë¡œ ê±°ì§“ë§ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.", dimension: "LIE", direction: "LIE" },
            
            // ì¶”ê°€ í•µì‹¬ ë¬¸í•­
            { id: 20, text: "ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•  ë•Œ, ë¨¼ì € ì „ì²´ êµ¬ì¡°ë¥¼ ì„¤ê³„í•œë‹¤.", dimension: "JP", direction: "J" },
            { id: 21, text: "ë…¼ìŸì—ì„œ ì´ê¸°ëŠ” ê²ƒë³´ë‹¤ ê´€ê³„ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•˜ë‹¤.", dimension: "TF", direction: "F" },
            { id: 22, text: "í˜„ì¬ ë²Œì–´ì§€ëŠ” ì¼ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ë¯¸ë˜ ê±±ì •ë³´ë‹¤ ë‚«ë‹¤.", dimension: "SN", direction: "S" },
            { id: 23, text: "ì—¬ëŸ¬ ì‚¬ëŒê³¼ ë™ì‹œì— ëŒ€í™”í•˜ëŠ” ê²ƒì´ ì–´ë µì§€ ì•Šë‹¤.", dimension: "EI", direction: "E" },
            { id: 24, text: "ê·œì¹™ê³¼ ì ˆì°¨ë¥¼ ë”°ë¥´ëŠ” ê²ƒì´ íš¨ìœ¨ì ì´ë‹¤.", dimension: "JP", direction: "J" },
        ];

        const AFK_THRESHOLD = 30000; // 30ì´ˆ

        const userData = {
            currentQuestion: 0,
            answers: [],
            startTime: null,
            questionStartTime: null,
            toggleCounts: {},
            idleTimes: [],
            totalResponseTime: 0,
            afkCount: 0,
        };

        let currentSelection = null;
        let questionDisplayTime = null;

        // ========== í…ŒìŠ¤íŠ¸ ì‹œì‘ ==========
        function startTest() {
            document.querySelector('.intro-screen').classList.remove('active');
            document.querySelector('.question-screen').classList.add('active');
            userData.startTime = Date.now();
            showQuestion(0);
            
            // ë””ë²„ê·¸ ëª¨ë“œ (Shift + Dë¡œ í† ê¸€)
            document.addEventListener('keydown', (e) => {
                if (e.shiftKey && e.key === 'D') {
                    document.getElementById('metadataOverlay').classList.toggle('show');
                }
            });
        }

        // ========== ì§ˆë¬¸ í‘œì‹œ ==========
        function showQuestion(index) {
            if (index >= questions.length) {
                calculateResults();
                return;
            }

            const question = questions[index];
            userData.currentQuestion = index;
            userData.questionStartTime = Date.now();
            questionDisplayTime = Date.now();
            currentSelection = null;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('questionNumber').textContent = `Question ${index + 1} of ${questions.length}`;
            document.getElementById('questionText').textContent = question.text;
            document.getElementById('progressFill').style.width = `${((index + 1) / questions.length) * 100}%`;

            // ì„ íƒì§€ ìƒì„± (5ì  ì²™ë„)
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            const options = [
                { value: 5, label: 'ë§¤ìš° ê·¸ë ‡ë‹¤' },
                { value: 4, label: 'ê·¸ë ‡ë‹¤' },
                { value: 3, label: 'ë³´í†µì´ë‹¤' },
                { value: 2, label: 'ì•„ë‹ˆë‹¤' },
                { value: 1, label: 'ì „í˜€ ì•„ë‹ˆë‹¤' }
            ];

            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = opt.label;
                div.dataset.value = opt.value;
                
                div.addEventListener('click', () => selectOption(div, opt.value, question));
                
                optionsContainer.appendChild(div);
            });
        }

        // ========== ì˜µì…˜ ì„ íƒ ==========
        function selectOption(element, value, question) {
            const responseTime = Date.now() - questionDisplayTime;
            
            // ì¬ì„ íƒ ì¶”ì 
            if (currentSelection !== null) {
                userData.toggleCounts[question.id] = (userData.toggleCounts[question.id] || 0) + 1;
                element.classList.add('toggled');
            }

            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            currentSelection = value;

            // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
            updateDebugInfo(responseTime, userData.toggleCounts[question.id] || 0);

            // 1ì´ˆ í›„ ë‹¤ìŒ ì§ˆë¬¸
            setTimeout(() => {
                const isAfk = responseTime > AFK_THRESHOLD;
                if (isAfk) {
                    userData.afkCount++;
                }

                userData.answers.push({
                    questionId: question.id,
                    dimension: question.dimension,
                    direction: question.direction,
                    value: value,
                    responseTime: responseTime,
                    toggles: userData.toggleCounts[question.id] || 0,
                    consistency: question.consistency,
                    isAfk: isAfk
                });

                userData.totalResponseTime += responseTime;
                showQuestion(userData.currentQuestion + 1);
            }, 1000);
        }

        // ========== ë””ë²„ê·¸ ì •ë³´ ==========
        function updateDebugInfo(rt, toggles) {
            const overlay = document.getElementById('metadataOverlay');
            overlay.innerHTML = `
                RT: ${rt}ms<br>
                Toggles: ${toggles}<br>
                Q: ${userData.currentQuestion + 1}/${questions.length}
            `;
        }

        // ========== ì´ìƒ íŒ¨í„´ ê°ì§€ ==========
        function detectAbnormalPatterns(answers) {
            const report = {
                isAbnormal: false,
                reasons: []
            };

            const validAnswers = answers.filter(a => !a.isAfk);
            if (validAnswers.length < 5) return report; // ë°ì´í„° ë¶€ì¡±

            // 1. Rapid Fire Check (ì´ˆê³ ì† ì‘ë‹µ)
            const fastAnswers = validAnswers.filter(a => a.responseTime < 800).length;
            if (fastAnswers > validAnswers.length * 0.6) {
                report.isAbnormal = true;
                report.reasons.push("ë¹„í˜„ì‹¤ì ìœ¼ë¡œ ë¹ ë¥¸ ì‘ë‹µ ì†ë„ (ë¬´ì‘ìœ„ ì„ íƒ ì˜ì‹¬)");
            }

            // 2. Straightlining (ì¼ì§ì„  ì‘ë‹µ)
            const counts = {};
            validAnswers.forEach(a => counts[a.value] = (counts[a.value] || 0) + 1);
            const maxCount = Math.max(...Object.values(counts));
            if (maxCount > validAnswers.length * 0.9) {
                report.isAbnormal = true;
                report.reasons.push("íŠ¹ì • ì‘ë‹µ ë°˜ë³µ (ë¶ˆì„±ì‹¤ ì‘ë‹µ íŒ¨í„´)");
            }

            // 3. Robotic Rhythm (ê¸°ê³„ì  ë¦¬ë“¬)
            const times = validAnswers.map(a => a.responseTime);
            const mean = times.reduce((a, b) => a + b, 0) / times.length;
            const variance = times.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / times.length;
            const stdDev = Math.sqrt(variance);

            if (stdDev < 150) {
                report.isAbnormal = true;
                report.reasons.push("ì¸ìœ„ì ì¸ ì‘ë‹µ ë¦¬ë“¬ ê°ì§€ (ë§¤í¬ë¡œ/íŒ¨í„´ ì¡°ì‘)");
            }

            return report;
        }

        // ========== ê²°ê³¼ ê³„ì‚° ==========
        function calculateResults() {
            document.querySelector('.question-screen').classList.remove('active');
            document.querySelector('.result-screen').classList.add('active');

            // ì´ìƒ íŒ¨í„´ ë¶„ì„ í™•ì¸
            const patternReport = detectAbnormalPatterns(userData.answers);

            // MBTI ì ìˆ˜ ê³„ì‚°
            const scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            const dimensions = { EI: [], SN: [], TF: [], JP: [] };

            userData.answers.forEach((ans, index) => {
                if (ans.dimension === 'LIE') return;

                // ê°€ì¤‘ì¹˜ ë¶€ì—¬: ë°˜ì‘ ì‹œê°„ì´ ì§§ê³  ì¬ì„ íƒì´ ì—†ì„ìˆ˜ë¡ í™•ì‹ ë„ ë†’ìŒ
                let weight = 1.0;

                // Warm-up êµ¬ê°„ (ì²˜ìŒ 3ë¬¸í•­)
                if (index < 3) {
                    weight = 0.2; // ë‚®ì€ ê°€ì¤‘ì¹˜ (ì—°ìŠµ/ì ì‘ êµ¬ê°„)
                } else if (ans.isAfk) {
                    // AFKì¸ ê²½ìš° ì‹œê°„ ê°€ì¤‘ì¹˜ ì œì™¸ (ê¸°ë³¸ ê°€ì¤‘ì¹˜ 1.0 ì ìš©)
                } else {
                    if (ans.responseTime < 2000) weight += 0.3; // ë¹ ë¥¸ ì‘ë‹µ
                    if (ans.toggles === 0) weight += 0.2; // ì¬ì„ íƒ ì—†ìŒ
                    if (ans.toggles > 2) weight -= 0.3; // ê³¼ë„í•œ ì¬ì„ íƒ
                }

                const adjustedValue = ans.value * weight;

                if (ans.direction === 'E' || ans.direction === 'I') {
                    scores[ans.direction] += adjustedValue;
                    dimensions.EI.push(ans);
                } else if (ans.direction === 'S' || ans.direction === 'N') {
                    scores[ans.direction] += adjustedValue;
                    dimensions.SN.push(ans);
                } else if (ans.direction === 'T' || ans.direction === 'F') {
                    scores[ans.direction] += adjustedValue;
                    dimensions.TF.push(ans);
                } else if (ans.direction === 'J' || ans.direction === 'P') {
                    scores[ans.direction] += adjustedValue;
                    dimensions.JP.push(ans);
                }
            });

            // MBTI ê²°ì •
            const mbti = 
                (scores.E > scores.I ? 'E' : 'I') +
                (scores.S > scores.N ? 'S' : 'N') +
                (scores.T > scores.F ? 'T' : 'F') +
                (scores.J > scores.P ? 'J' : 'P');

            // ì¼ê´€ì„± ì²´í¬
            const consistencyScore = checkConsistency();

            // Lie Scale (ì •ì§ë„)
            const lieAnswers = userData.answers.filter(a => a.dimension === 'LIE');
            const lieScore = lieAnswers.reduce((sum, a) => sum + (a.value >= 4 ? 1 : 0), 0);
            const honestyScore = Math.max(0, 100 - (lieScore * 20));

            // ì‹ ë¢°ë„ ê³„ì‚°
            const avgResponseTime = userData.totalResponseTime / userData.answers.length;
            const totalToggles = Object.values(userData.toggleCounts).reduce((sum, val) => sum + val, 0);
            
            let confidence = 100;
            if (consistencyScore < 70) confidence -= 15;
            if (honestyScore < 60) confidence -= 10;
            if (avgResponseTime < 1500) confidence -= 5; // ë„ˆë¬´ ë¹ ë¦„
            if (totalToggles > 15) confidence -= 10; // ê³¼ë„í•œ ì¬ì„ íƒ
            if (userData.afkCount > 0) confidence -= (userData.afkCount * 5); // AFK ê°ì 

            // UI ì—…ë°ì´íŠ¸
            if (patternReport.isAbnormal) {
                document.getElementById('mbtiResult').textContent = "ANALYSIS FAILED";
                document.getElementById('mbtiResult').style.fontSize = "2rem";
                document.getElementById('mbtiResult').style.color = "var(--warning)";
                confidence = 0;
            } else {
                document.getElementById('mbtiResult').textContent = mbti;
            }

            document.getElementById('confidenceScore').textContent = `${Math.round(confidence)}%`;
            document.getElementById('avgResponseTime').textContent = `${(avgResponseTime / 1000).toFixed(1)}s`;
            document.getElementById('totalToggles').textContent = totalToggles;
            document.getElementById('honestyScore').textContent = `${honestyScore}%`;

            // ë°ì´í„° í’ˆì§ˆ ë¶„ì„ ë³´ê³ ì„œ ì—…ë°ì´íŠ¸
            const totalQuestions = userData.answers.length;
            const validCount = totalQuestions - userData.afkCount;
            const validRate = Math.round((validCount / totalQuestions) * 100);

            if (patternReport.isAbnormal) {
                 document.getElementById('validResponseRate').textContent = "ë°ì´í„° ì‹ ë¢°ë„ ì¹˜ëª…ì  ê²°í•¨ ë°œê²¬";
                 document.getElementById('afkAnalysis').innerHTML = `<strong style="color: var(--warning)">ë¹„ì •ìƒ íŒ¨í„´ ê°ì§€:</strong> ${patternReport.reasons.join(", ")}`;
                 document.getElementById('qualityComment').textContent = "\"ì¸ìœ„ì ì¸ ì¡°ì‘ íŒ¨í„´ì´ ê°ì§€ë˜ì–´ ë¶„ì„ ê²°ê³¼ë¥¼ ì‚°ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\"";
            } else {
                document.getElementById('validResponseRate').textContent =
                    `${validRate}% (ì´ ${totalQuestions}ë¬¸í•­ ì¤‘ ${userData.afkCount}ë¬¸í•­ì—ì„œ ë¹„ì •ìƒì  ì‘ë‹µ íë¦„ ê°ì§€)`;

                document.getElementById('afkAnalysis').innerHTML =
                    `ê·€í•˜ëŠ” ê²€ì‚¬ ì¤‘ <strong>${userData.afkCount}íšŒì˜ ì§‘ì¤‘ë ¥ ì €í•˜(AFK)</strong> êµ¬ê°„ì´ í¬ì°©ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ê²°ê³¼ì˜ ì¼ê´€ì„±ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” ìš”ì†Œì…ë‹ˆë‹¤.`;

                let qComment = "";
                if (userData.afkCount === 0) {
                    qComment = "ëª¨ë“  ë¬¸í•­ì—ì„œ ì§‘ì¤‘ë ¥ì„ ìœ ì§€í•˜ì—¬ ì‘ë‹µ íë¦„ì´ ë§¤ìš° ì›í™œí•©ë‹ˆë‹¤. ê²°ê³¼ì˜ ì‹ ë¢°ë„ê°€ ë†’ìŠµë‹ˆë‹¤.";
                } else if (userData.afkCount <= 3) {
                    qComment = "ì¼ë¶€ ë¬¸í•­ì—ì„œ ì‘ë‹µ íë¦„ì´ ëŠê²¼ìœ¼ë‚˜, ì „ë°˜ì ì¸ íŒ¨í„´ì´ ì¼ê´€ë˜ì–´ ê²°ê³¼ê°’ì€ ìœ íš¨í•œ ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.";
                } else {
                    qComment = "ì¦ì€ ì§‘ì¤‘ë ¥ ì €í•˜ë¡œ ì¸í•´ ì¼ë¶€ ê²°ê³¼ì˜ ì •í™•ë„ê°€ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¬ê²€ì‚¬ë¥¼ ê¶Œì¥í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ì…ë‹ˆë‹¤.";
                }
                document.getElementById('qualityComment').textContent = `"${qComment}"`;
            }

            // ë°” ì°¨íŠ¸ ìƒì„±
            createBarChart(scores);

            // ì¸ì‚¬ì´íŠ¸ ìƒì„±
            generateInsights(mbti, avgResponseTime, totalToggles, consistencyScore, honestyScore, dimensions);
        }

        // ========== ì¼ê´€ì„± ì²´í¬ ==========
        function checkConsistency() {
            const consistencyPairs = [];
            
            userData.answers.forEach(ans => {
                if (ans.consistency) {
                    const original = userData.answers.find(a => a.questionId === ans.consistency);
                    if (original) {
                        const diff = Math.abs(ans.value - original.value);
                        consistencyPairs.push(diff <= 1 ? 1 : 0);
                    }
                }
            });

            if (consistencyPairs.length === 0) return 100;
            const score = (consistencyPairs.filter(x => x === 1).length / consistencyPairs.length) * 100;
            return score;
        }

        // ========== ë°” ì°¨íŠ¸ ìƒì„± ==========
        function createBarChart(scores) {
            const chart = document.getElementById('mbtiBarChart');
            chart.innerHTML = '';

            const pairs = [
                { label: 'E vs I', e: scores.E, i: scores.I },
                { label: 'S vs N', e: scores.S, i: scores.N },
                { label: 'T vs F', e: scores.T, i: scores.F },
                { label: 'J vs P', e: scores.J, i: scores.P }
            ];

            pairs.forEach(pair => {
                const total = pair.e + pair.i;
                const percentage = Math.round((pair.e / total) * 100);

                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${pair.label}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width: ${percentage}%">${percentage}%</div>
                    </div>
                `;
                chart.appendChild(barItem);
            });
        }

        // ========== ì¸ì‚¬ì´íŠ¸ ìƒì„± ==========
        function generateInsights(mbti, avgRT, toggles, consistency, honesty, dimensions) {
            // í–‰ë™ íŒ¨í„´ ë¶„ì„
            let behaviorText = '';
            if (avgRT < 2000) {
                behaviorText = `í‰ê·  ì‘ë‹µ ì‹œê°„ ${(avgRT/1000).toFixed(1)}ì´ˆë¡œ ë§¤ìš° ë¹ ë¥¸ ì‘ë‹µ ì†ë„ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤. ì´ëŠ” ìê¸° ì¸ì‹ì´ ëª…í™•í•˜ê±°ë‚˜ ì§ê´€ì  íŒë‹¨ ì„±í–¥ì´ ê°•í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.`;
            } else if (avgRT > 5000) {
                behaviorText = `í‰ê·  ì‘ë‹µ ì‹œê°„ ${(avgRT/1000).toFixed(1)}ì´ˆë¡œ ì‹ ì¤‘í•œ ì‚¬ê³  ê³¼ì •ì„ ê±°ì³¤ìŠµë‹ˆë‹¤. ì´ëŠ” ê¹Šì€ ìê¸° ì„±ì°° ë˜ëŠ” ë‚´ì  ê°ˆë“±ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.`;
            } else {
                behaviorText = `í‰ê·  ì‘ë‹µ ì‹œê°„ ${(avgRT/1000).toFixed(1)}ì´ˆë¡œ ì ì ˆí•œ ìˆ™ê³  ì‹œê°„ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.`;
            }

            if (toggles > 15) {
                behaviorText += ` ì´ ${toggles}íšŒì˜ ë‹µë³€ ë³€ê²½ì´ ìˆì—ˆìœ¼ë©°, ì´ëŠ” P(ì¸ì‹í˜•) ì„±í–¥ì˜ ìœ ì—°í•œ ì‚¬ê³ ë°©ì‹ ë˜ëŠ” ê²°ì •ì— ëŒ€í•œ ë¶ˆí™•ì‹¤ì„±ì„ ë°˜ì˜í•©ë‹ˆë‹¤.`;
            }

            // ì •ì§ë„ ë¶„ì„
            let validityText = '';
            if (honesty < 60) {
                validityText = `ì •ì§ë„ ì ìˆ˜ê°€ ${honesty}%ë¡œ, ì‚¬íšŒì ìœ¼ë¡œ ë°”ëŒì§í•´ ë³´ì´ë ¤ëŠ” ìê¸° ê²€ì—´ ê²½í–¥ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ì„±ê²©ë³´ë‹¤ 'ì´ìƒì ì¸ ëª¨ìŠµ'ì„ ì„ íƒí–ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.`;
            } else if (honesty > 90) {
                validityText = `ì •ì§ë„ ì ìˆ˜ ${honesty}%ë¡œ, ë§¤ìš° ì†”ì§í•˜ê²Œ ì‘ë‹µí•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ì˜ ì‹ ë¢°ì„±ì´ ë†’ìŠµë‹ˆë‹¤.`;
            } else {
                validityText = `ì •ì§ë„ ì ìˆ˜ ${honesty}%ë¡œ, ì ì ˆí•œ ìˆ˜ì¤€ì˜ ìê¸° ê°œë°©ì„±ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.`;
            }

            // ì¢…í•© í•´ì„
            let comprehensiveText = `ë‹¹ì‹ ì˜ MBTI ìœ í˜•ì€ ${mbti}ì…ë‹ˆë‹¤. `;
            
            if (consistency < 70) {
                comprehensiveText += `ë‹¤ë§Œ, ì¼ê´€ì„± ì ìˆ˜ê°€ ${Math.round(consistency)}%ë¡œ ë‚®ì€ í¸ì…ë‹ˆë‹¤. ì´ëŠ” í˜„ì¬ ì‹¬ë¦¬ì  ì „í™˜ê¸°ì— ìˆê±°ë‚˜, ìƒí™©ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í–‰ë™í•˜ëŠ” ìœ ì—°ì„±ì„ ê°€ì§€ê³  ìˆìŒì„ ì˜ë¯¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `;
            }

            comprehensiveText += `ì´ ê²°ê³¼ëŠ” ë‹¨ìˆœ ì„ íƒë¿ ì•„ë‹ˆë¼ ë‹¹ì‹ ì˜ ì‘ë‹µ ì†ë„, ì¬ê³  ê³¼ì •, ì¼ê´€ì„±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•œ ê²ƒì…ë‹ˆë‹¤.`;

            document.getElementById('behaviorInsight').textContent = behaviorText;
            document.getElementById('validityInsight').textContent = validityText;
            document.getElementById('comprehensiveInsight').textContent = comprehensiveText;
        }
    </script>
</body>
</html>
